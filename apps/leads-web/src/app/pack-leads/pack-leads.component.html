<mat-card>
  <mat-card-header>
    <mat-icon mat-card-avatar>folder</mat-icon>
    <mat-card-title>North Dakota NAICS Leads</mat-card-title>
    <mat-card-subtitle
      >Manage and analyze lead data from MongoDB</mat-card-subtitle
    >
  </mat-card-header>
  <mat-card-content>
    <!-- NAICS Code Search Bar -->
    <div class="naics-search-bar">
      <mat-chip-list>
        <mat-chip *ngFor="let code of selectedNaicsCodes" [removable]="true" (removed)="removeNaicsCode(code)">
          {{ code }}
          <button matChipRemove aria-label="Remove NAICS code">
            <mat-icon>close</mat-icon>
          </button>
        </mat-chip>
      </mat-chip-list>
      <button mat-raised-button color="primary" (click)="toggleNaicsSearchMode()" class="naics-search-mode-btn">
        <mat-icon>{{ naicsSearchMode === 'any' ? 'scatter_plot' : 'filter_list' }}</mat-icon>
        {{ naicsSearchMode === 'any' ? 'Any of the words' : 'All of the words' }}
      </button>
    </div>

    <div class="controls-row">

      <button
        mat-raised-button
        color="primary"
        (click)="searchNdIt()"
        [disabled]="loading"
      >
        <mat-icon>search</mat-icon> Search ND IT Contracts
      </button>

      <button
        class="naics-toggle-btn"
        (click)="showNaicsCodes = !showNaicsCodes"
        *ngIf="leads.length > 0"
      >
          <mat-icon>{{ showNaicsCodes ? 'visibility' : 'visibility_off' }}</mat-icon>
          {{ showNaicsCodes ? 'Hide All' : 'Show All' }} NAICS Codes
      </button>

      <button
        mat-stroked-button
        (click)="toggleSampleData()"
        *ngIf="leads.length > 0"
        [matBadge]="sampleCount.toString()"
        [matBadgeColor]="showSampleData ? 'primary' : 'warn'"
        matBadgeSize="small"
        [color]="showSampleData ? 'primary' : 'accent'"
      >
        <mat-icon>{{ showSampleData ? 'visibility' : 'visibility_off' }}</mat-icon>
        {{ showSampleData ? 'Sample Data: ON' : 'Live Data: ON' }}
      </button>

      <div
        *ngIf="leads.length > 0"
        class="chip-row"
      >
        <mat-chip
          *ngIf="sampleCount > 0"
          class="sample-indicator sample-chip"
          matTooltip="Show tracked sample contracts"
          (click)="toggleLabOverlay()"
        >
          <mat-icon>flask</mat-icon>
          {{ sampleCount }} Contracts
        </mat-chip>
        <div *ngIf="showLabOverlay" class="lab-overlay">
          <div class="lab-modal">
            <div class="lab-modal-header">
              <mat-icon class="lab-modal-icon">flask</mat-icon>
              <span class="lab-modal-title">Sample Contracts Lab</span>
              <button mat-icon-button (click)="showLabOverlay = false" class="lab-modal-close"><mat-icon>close</mat-icon></button>
            </div>
            <div class="lab-modal-controls">
              <button mat-stroked-button color="primary" (click)="showSampleContracts = !showSampleContracts">
                <mat-icon>{{ showSampleContracts ? 'description' : 'business' }}</mat-icon>
                {{ showSampleContracts ? 'Show Sample Leads' : 'Show Sample Contracts' }}
              </button>
            </div>
            <div *ngIf="showSampleContracts">
              <!-- Material Table for Sample Contracts -->
              <div class="table-filter-row">
                <mat-form-field appearance="outline" class="table-filter-field">
                  <mat-label>Filter contracts</mat-label>
                  <input matInput [(ngModel)]="tableFilter" (ngModelChange)="onTableFilterChange($event)" placeholder="Search by number, title, company" />
                  <button mat-icon-button matSuffix *ngIf="tableFilter" (click)="onTableFilterChange('')"><mat-icon>close</mat-icon></button>
                </mat-form-field>
              </div>
              <table mat-table [dataSource]="filteredSampleContracts" class="mat-elevation-z2 sample-contracts-table">
                <!-- Contract Number Column -->
                <ng-container matColumnDef="contractNumber">
                  <th mat-header-cell *matHeaderCellDef>Number</th>
                  <td mat-cell *matCellDef="let contract">{{ contract.contractNumber }}</td>
                </ng-container>
                <!-- Title Column -->
                <ng-container matColumnDef="title">
                  <th mat-header-cell *matHeaderCellDef>Title</th>
                  <td mat-cell *matCellDef="let contract">{{ contract.title }}</td>
                </ng-container>
                <!-- Company Column -->
                <ng-container matColumnDef="companyName">
                  <th mat-header-cell *matHeaderCellDef>Company</th>
                  <td mat-cell *matCellDef="let contract">{{ contract.companyName }}</td>
                </ng-container>
                <!-- Value Column -->
                <ng-container matColumnDef="value">
                  <th mat-header-cell *matHeaderCellDef>Value</th>
                  <td mat-cell *matCellDef="let contract">${{ contract.value | number }}</td>
                </ng-container>
                <!-- Award Date Column -->
                <ng-container matColumnDef="awardDate">
                  <th mat-header-cell *matHeaderCellDef>Awarded</th>
                  <td mat-cell *matCellDef="let contract">{{ contract.awardDate | date:'mediumDate' }}</td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['contractNumber', 'title', 'companyName', 'value', 'awardDate']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['contractNumber', 'title', 'companyName', 'value', 'awardDate'];"></tr>
              </table>
              <mat-paginator
                [length]="filteredSampleContractsTotal"
                [pageSize]="pageSize"
                [pageIndex]="pageIndex"
                [pageSizeOptions]="[5, 10, 20]"
                (page)="onTablePageChange($event)"
                showFirstLastButtons>
              </mat-paginator>
              <div *ngIf="filteredSampleContractsTotal === 0" class="lab-contract-empty">No sample contracts found.</div>
            </div>
            <div *ngIf="!showSampleContracts">
              <!-- Sample Leads Table Placeholder -->
              <div *ngIf="filteredLeads.length > 0">
                <div *ngFor="let lead of filteredLeads">
                  <div *ngIf="hasSampleContracts(lead)" class="lab-contract">
                    <div class="lab-contract-title">{{ lead.companyName }} ({{ lead.leadId }})</div>
                    <div class="lab-contract-description">{{ lead.naicsDescription }} | {{ lead.city }}, {{ lead.stateCode }}</div>
                    <div class="lab-contract-info">Contracts: {{ lead.contracts?.length || 0 }}</div>
                  </div>
                </div>
              </div>
              <div *ngIf="filteredLeads.length === 0" class="lab-contract-empty">No sample leads found.</div>
            </div>
          </div>
        </div>
        <mat-chip
          *ngIf="testCount > 0"
          style="
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
          "
        >
          <mat-icon>bug_report</mat-icon>
          {{ testCount }} Test
        </mat-chip>
        <mat-chip
          *ngIf="realCount > 0"
          style="
            background: linear-gradient(135deg, #4caf50, #388e3c);
            color: white;
          "
        >
          <mat-icon>check_circle</mat-icon>
          {{ realCount }} Real
        </mat-chip>
      </div>
    </div>

    <mat-spinner
      *ngIf="loading"
      diameter="40"
      class="main-spinner"
    ></mat-spinner>

    <div *ngIf="!loading && hasRun && leads.length === 0" class="no-results">
      <mat-icon color="warn">error_outline</mat-icon>
      <p class="error-text">No leads found</p>
    </div>

    <div *ngIf="!loading && scriptOutput" class="script-output">
      <mat-icon>info</mat-icon>
      <span>{{ scriptOutput }}</span>
    </div>

    <mat-list *ngIf="filteredLeads.length > 0">
      <mat-list-item
        *ngFor="let lead of filteredLeads"
        (click)="toggleExpand(lead.leadId)"
        class="clickable"
        title="Click to expand contracts"
      >
        <mat-icon matListItemIcon>business</mat-icon>
        <div matListItemTitle>{{ lead.companyName }}</div>
        <div matListItemLine>
          <strong>ID:</strong> {{ lead.leadId }}
          <span *ngIf="showNaicsCodes">
            | <strong>NAICS:</strong> {{ lead.naicsCode }}
            <span *ngIf="lead.naicsDescription"
              >- {{ lead.naicsDescription }}</span
            ></span
          >
          | <strong>Location:</strong> {{ lead.city }}, {{ lead.stateCode }}
        </div>
        <div matListItemLine>
          <strong>Status:</strong> {{ lead.registrationStatus }}
          <span *ngIf="lead.contracts && lead.contracts.length > 0">
            |
            <strong
              >{{ lead.contracts.length }} Contract{{
                lead.contracts.length > 1 ? 's' : ''
              }}</strong
            >
            (${{ calculateTotalValue(lead.contracts) }})
          </span>
          <mat-chip-set
            *ngIf="lead.businessType && lead.businessType.length > 0"
            style="display: inline-flex; vertical-align: middle"
          >
            <mat-chip *ngFor="let type of lead.businessType.slice(0, 2)">{{
              type
            }}</mat-chip>
          </mat-chip-set>
          <mat-chip *ngIf="hasSampleContracts(lead)" class="sample-indicator">
            <mat-icon>science</mat-icon> Sample
          </mat-chip>
          <mat-chip *ngIf="hasRealContracts(lead)" class="real-indicator">
            <mat-icon>verified</mat-icon> Real
          </mat-chip>
          <mat-icon
            class="expand-icon"
            *ngIf="lead.contracts && lead.contracts.length > 0"
            >{{
              isExpanded(lead.leadId) ? 'expand_less' : 'expand_more'
            }}</mat-icon
          >
        </div>

        <!-- Expanded Contract Details -->
        <div
          *ngIf="
            isExpanded(lead.leadId) &&
            lead.contracts &&
            lead.contracts.length > 0
          "
          class="contracts-expanded"
          tabindex="0"
          role="region"
          [attr.aria-label]="'Contract details for ' + lead.companyName"
          (click)="$event.stopPropagation()"
          (keydown.enter)="$event.stopPropagation()"
          (keydown.space)="$event.stopPropagation()"
        >
          <div
            *ngFor="let contract of lead.contracts"
            class="contract-detail"
            [class.sample-contract]="contract.sampleData"
            [class.real-contract]="!contract.sampleData && !contract.isTest"
            [class.test-contract]="contract.isTest"
          >
            <div class="contract-header">
              <mat-icon>description</mat-icon>
              <strong>{{ contract.contractNumber }}</strong>
              <span class="contract-badge">{{
                contract.sampleData ? 'SAMPLE' : contract.isTest ? 'TEST' : 'REAL'
              }}</span>
            </div>
            <div class="contract-title">{{ contract.title }}</div>
            <div class="contract-description" *ngIf="contract.description">
              {{ contract.description }}
            </div>
            <div class="contract-info">
              <span class="contract-value">
                <mat-icon>attach_money</mat-icon>
                ${{ formatValue(contract.value) }}
              </span>
              <span class="contract-status">
                <mat-icon>{{
                  contract.status === 'Active' ? 'check_circle' : 'done'
                }}</mat-icon>
                {{ contract.status }}
              </span>
              <span class="contract-date">
                <mat-icon>calendar_today</mat-icon>
                {{ contract.awardDate | date : 'MMM d, y' }}
              </span>
            </div>
          </div>
        </div>
      </mat-list-item>
    </mat-list>
  </mat-card-content>
</mat-card>
